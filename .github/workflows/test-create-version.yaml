name: Test - Create Version

on:
  workflow_dispatch:
    inputs:
      pull_request_number:
        description: 'Pull Request Number'
        required: true

jobs:
  create_version:
    name: Create Test Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      tag: ${{ steps.version_info.outputs.tag }}

    steps:
      - name: Check user permissions
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });

            if (!['admin', 'write'].includes(permission.permission)) {
              core.setFailed('Only repository maintainers can trigger this workflow');
              return;
            }

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Create new version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.inputs.pull_request_number }}
        run: |
          # Fetch the PR branch
          PR_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER")

          PR_BRANCH=$(echo $PR_DATA | jq -r .head.ref)

          # Checkout PR branch
          git fetch origin $PR_BRANCH
          git checkout $PR_BRANCH

          # Get current version
          CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          # Remove 'v' prefix and any branch suffix
          CURRENT_VERSION=$(echo $CURRENT_VERSION | sed 's/v\([0-9.]*\).*/\1/')
          if [[ ! $CURRENT_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              CURRENT_VERSION="0.0.0"
          fi

          # Split version into components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Always increment patch version
          NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"

          # Sanitize branch name (remove special characters and convert to lowercase)
          BRANCH_NAME=$(echo $PR_BRANCH | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g')

          # Create new version with branch name
          FULL_VERSION="${NEW_VERSION}-${BRANCH_NAME}-test"
          NEW_TAG="v${FULL_VERSION}"

          # Create version commit and tag
          git tag -a $NEW_TAG -m "$NEW_TAG"

          # Push changes back to PR branch
          git push origin $NEW_TAG

          echo "Created new version: $FULL_VERSION"
          echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT

      - name: Update PR with version info
        id: version_info
        uses: actions/github-script@v7
        with:
          script: |
            const newVersion = require('fs').readFileSync('VERSION', 'utf8').trim();

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.pull_request_number }},
              body: `üè∑Ô∏è New version generated: v${newVersion}`
            });

            core.setOutput('tag', newVersion)

      - name: Report status
        if: ${{ success() }}
        run: |
          echo "Pipeline executed successfully."

  build_docker:
    name: Build Docker Image
    needs: create_version
    permissions:
      packages: write
      contents: read
      id-token: write
      attestations: write
    uses: ./.github/workflows/test-build-docker-image.yaml
    with:
      tag: ${{ needs.create_version.outputs.tag }}
    secrets: inherit
