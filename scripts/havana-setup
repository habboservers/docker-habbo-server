#!/bin/bash

: "${HAVANA_RELEASE_VERSION:=latest}"
: "${HAVANA_GITHUB_REPOSITORY:=Quackster/Havana}"

# Function to get latest release version
get_latest_version() {
    curl -s "https://api.github.com/repos/${HAVANA_GITHUB_REPOSITORY}/releases/latest" | jq -r '.tag_name'
}

# Function to get current installed version
get_installed_version() {
    if [ -f "/tmp/havana_version" ]; then
        cat "/tmp/havana_version"
    else
        echo "none"
    fi
}

# Function to download and install Havana
install_havana() {
    local version=$1
    echo "[level:INFO][docker-havana] Downloading $HAVANA_GITHUB_REPOSITORY version: $version"
    
    ASSET_URL=$(curl -s "https://api.github.com/repos/${HAVANA_GITHUB_REPOSITORY}/releases/latest" | jq -r '.assets[0].browser_download_url')
    if [[ $ASSET_URL ]]; then
        if curl -fsL -o havana.zip "${ASSET_URL}" &&
           unzip -o havana.zip -d ${HAVANA_BASE_DIR} && 
           rm havana.zip; then
            echo "$version" > "/tmp/havana_version"
            echo "[level:INFO][docker-havana] Successfully installed $HAVANA_GITHUB_REPOSITORY version: $version"
            return 0
        else
            echo "[level:ERROR][docker-havana] Failed to install $HAVANA_GITHUB_REPOSITORY version: $version" >&2
            return 1
        fi
    else
        echo "[level:ERROR][docker-havana] Failed to get download URL for version: $version" >&2
        return 1
    fi
}

# Get latest version from GitHub
LATEST_VERSION=$(get_latest_version)
if [ -z "$LATEST_VERSION" ]; then
    echo "[level:ERROR][docker-havana] Failed to get latest version information" >&2
    exit 1
fi

# Get currently installed version
CURRENT_VERSION=$(get_installed_version)

echo "[level:INFO][docker-havana] Latest version: $LATEST_VERSION"
echo "[level:INFO][docker-havana] Current version: $CURRENT_VERSION"

# Check if we need to install/upgrade
if [ "$CURRENT_VERSION" = "none" ] || [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
    echo "[level:INFO][docker-havana] New version detected, installing/upgrading..."
    if ! install_havana "$LATEST_VERSION"; then
        echo "[level:ERROR][docker-havana] Installation/upgrade failed!" >&2
        exit 1
    fi
else
    echo "[level:INFO][docker-havana] Already running latest version, skipping installation"
fi

# Setup Web Server if not disabled
if [ "$HAVANA_DISABLE_WEBSERVER" != "true" ]; then
    if [ ! -f "/tmp/havana_web_setup_complete" ]; then
        echo "[level:INFO][docker-havana-web] Running Web Server setup..."
        if "$DEFAULT_SCRIPTS_PATH/havana-setupWebServer"; then
            echo "[level:INFO][docker-havana-web] Web Server setup executed successfully."
            echo "$LATEST_VERSION" > "/tmp/havana_web_setup_complete"
        else
            echo "[level:ERROR][docker-havana-web] ERROR: Web Server setup failed!" >&2
            exit 1
        fi
    else
        SETUP_VERSION=$(cat "/tmp/havana_web_setup_complete")
        if [ "$SETUP_VERSION" != "$LATEST_VERSION" ]; then
            echo "[level:INFO][docker-havana-web] New version detected, running Web Server setup..."
            if "$DEFAULT_SCRIPTS_PATH/havana-setupWebServer"; then
                echo "[level:INFO][docker-havana-web] Web Server setup executed successfully."
                echo "$LATEST_VERSION" > "/tmp/havana_web_setup_complete"
            else
                echo "[level:ERROR][docker-havana-web] ERROR: Web Server setup failed!" >&2
                exit 1
            fi
        else
            echo "[level:INFO][docker-havana-web] Web Server setup already complete for version $SETUP_VERSION, skipping..."
        fi
    fi
fi

# Setup Game Server if not disabled
if [ "$HAVANA_DISABLE_SERVER" != "true" ]; then
    if [ ! -f "/tmp/havana_server_setup_complete" ]; then
        echo "[level:INFO][docker-havana-server] Running Server setup..."
        if "$DEFAULT_SCRIPTS_PATH/havana-setupServer"; then
            echo "[level:INFO][docker-havana-server] Server setup executed successfully."
            echo "$LATEST_VERSION" > "/tmp/havana_server_setup_complete"
        else
            echo "[level:ERROR][docker-havana-server] ERROR: Server setup failed!" >&2
            exit 1
        fi
    else
        SETUP_VERSION=$(cat "/tmp/havana_server_setup_complete")
        if [ "$SETUP_VERSION" != "$LATEST_VERSION" ]; then
            echo "[level:INFO][docker-havana-server] New version detected, running Server setup..."
            if "$DEFAULT_SCRIPTS_PATH/havana-setupServer"; then
                echo "[level:INFO][docker-havana-server] Server setup executed successfully."
                echo "$LATEST_VERSION" > "/tmp/havana_server_setup_complete"
            else
                echo "[level:ERROR][docker-havana-server] ERROR: Server setup failed!" >&2
                exit 1
            fi
        else
            echo "[level:INFO][docker-havana-server] Server setup already complete for version $SETUP_VERSION, skipping..."
        fi
    fi
fi